<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1</title>
</head>
<body>
    <div id="app">
		<header>
			search: <input type="text" v-model="search"><br>
			<!-- {{search}} -->
			$<input type="number" v-model="min">-<input type="number" v-model="max">
		</header>
        <div>
            <main>               
                <div v-if="load">loading...</div>
                <div v-else class="productContainer">
                    <div v-for="(item, index) in product" :key="item.id">
                        <!-- <p>{{item.title}}</p> -->
                        <!-- <p>{{item.rating.rate}}</p> -->
                        <!-- 或這樣寫 <p>{{item['rating']['rate']}}</p> -->
                        <!-- <span v-for="count in parseInt(item['rating']['rate'])">{{count}}</span> -->
                        <span v-for="count in parseInt(item['rating']['rate'])">⭐</span>
                        <p>評論數:{{item.rating.count}}</p>
                        <!-- 或這樣寫 <p>{{item['rating']['count']}}</p> -->
                        <img :src="item.image" v-bind:alt="item.title">
                        <p>{{parsePrice(item.price)}}元</p>
                        <div>
                            <button v-on:click="reduceCount(index, item)">-</button>
                            <input type="number" min="0" v-model="count[index]">
                            <button @click="addCount(index, item)">+</button>
                        </div>
                    </div>
                </div>
            </main>
            <aside>
                <p>總計：{{total}}元</p>
                訂單
                <ul>
                    <li v-for="item in order" :key="item.id">ID {{item.id}}:{{item.count}}</li>
                </ul>
                <!-- {{order}} -->
            </aside>
        </div>	
    </div>
    <script src="https://unpkg.com/vue@next"></script>
    <script>
        Vue.createApp({
            data(){
                return {
                    load: false,
					source: [],
                    // product: [],
                    count: [],
                    // total: 0,
					search: '',
					min: 0,
					max: 0,
                    order: [],
                }
            },
			computed:{
				product(){
					let cache = this.source
					if(this.min > 0){//篩選最小價錢
						cache = cache.filter((item, index)=>{
							return item.price > this.min
						})
					}
					if(this.max > 0){//篩選最大價錢
						cache = cache.filter(item=>{
							return item.price < this.max
						})
					}
					if(this.search !== ''){//篩選相符標題
						cache = cache.filter(item=>{
							return item.title.includes(this.search)
						})
					}
					return cache
				},
				total(){
					let total = 0
					for ( const countIndex in this.product) {
						total += this.count[countIndex] * this.product[countIndex]['price']
					}
					return parseInt(total)
				}
			},
			watch:{
				//監聽data或computed
				total: {
					handler: function(newVal, oldVal) {
						if(newVal> 1000){
							alert('你要餓死了')
						}
					}
				}
			},
            methods:{
				parsePrice(price){
					return `TWD ${price*33}`
				},
                getResource(){
                    this.load = true
                    fetch('https://fakestoreapi.com/products/')
                    .then(res=>res.json())
                    .then(json=>{
                        this.source = json
                        //初始化商品數量
                        for ( item in this.product) {
                            this.count.push(0)
                        }
                        this.load = false
                    })
                },
                addCount(index, item){
                    this.count[index] += 1
                    const prodIndex = this.order.findIndex(orderItem =>{
                            return orderItem.id === item.id
                    })
                    if(prodIndex >= 0){
                        //如果訂單清單裡有這個商品，就將同樣ID的商品增加數量COUNT
                        // console.log(prodIndex);
                        this.order[prodIndex]['count'] += 1
                    }else{
                        //如果訂單清單裡面沒有這個商品，就新增一個訂定單商品
                        this.order.push({
                            id: item.id,
                            title: item.title,
                            price: item.price,
                            count: 1
                        })
                    }
                    this.setStorage()
                    // this.sumTotal()
                },
                reduceCount(index, item){
                    if(this.count[index] <= 0) return
                    this.count[index] -= 1

                    const prodIndex = this.order.findIndex(orderItem =>{
                            return orderItem.id === item.id
                    })

                    if(prodIndex < 0) return
                    if(this.order[prodIndex]['count'] > 1){
                        this.order[prodIndex]['count'] -= 1
                    }else{
                        this.order.splice(prodIndex, 1)
                    }
                    this.setStorage()
                },
                getStorage(){
                    let data = localStorage.getItem('assaas')
                    data = JSON.parse(data)
                    this.order = data? data:[]
                },
                setStorage(){
                    //  陣列或物件轉字串
                    const data = JSON.stringify(this.order)
                    localStorage.setItem('assaas', data)
                }
            },
			created() { //created: Vue實體被建立完
                // console.log('created:' + this.source.length)
                // this.getResource()
            },
            mounted(){
                this.getResource()
                this.getStorage()
                this.sourceCount = this.source.length
                // console.log('mounted' + this.source.length);
            },
	        beforeUnmount(){
                alert('beforeUnmount')
                console.log('beforeUnmount');
            }
        }).mount("#app")
    </script>
</body>
</html>
<style>
    .productContainer{
        display: inline-flex;
    }
    img{
        height: 5rem;
    }
</style>